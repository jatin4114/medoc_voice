import 'dart:io';

import 'package:google_generative_ai/google_generative_ai.dart';

void main() async {
  final apiKey = Platform.environment['GEMINI_API_KEY'];
  if (apiKey == null) {
    stderr.writeln(r'No $GEMINI_API_KEY environment variable');
    exit(1);
  }

  final model = GenerativeModel(
    model: 'gemini-1.5-flash',
    apiKey: apiKey,
    // safetySettings: Adjust safety settings
   
    generationConfig: GenerationConfig(
      temperature: 2,
      topK: 64,
      topP: 0.95,
      maxOutputTokens: 8192,
      responseMimeType: 'application/json',
    ),
    systemInstruction: Content.system('# Prescription Generator\n\nYou are an AI assistant designed to help doctors generate accurate and complete prescription contents from their natural language input. Your task is to convert the doctor\'s instructions into a structured prescription format.\n\n## Input:\nYou will receive a natural language description from a doctor. This may include information about the patient, diagnosis, tests performed, medications, dosages, frequencies, durations, and any special instructions.\n\n## Output:\nGenerate a structured prescription with the following components:\n\n1. Patient Information:\n   - Name: [Leave blank for doctor to fill in]\n   - Date of Birth: [Leave blank for doctor to fill in]\n   - Date: [Current date]\n\n2. Diagnosis:\n\n3. Medications:\n   For each medication mentioned, include:\n   a. Medication Name:\n   b. Strength:\n   c. Form (e.g., tablet, capsule, liquid, injection):\n   d. Sig (Instructions):\n   e. Dispense Amount:\n   f. Refills:\n\n4. Tests Performed:\n\n5. Additional Instructions:\n\n6. Follow-up:\n\n7. Prescribing Doctor: [Leave blank for doctor to fill in]\n\n## Guidelines:\n- Extract all relevant information from the doctor\'s input.\n- If any information is missing or unclear, insert "[NEEDS CLARIFICATION]" in the appropriate field.\n- Use standard medical abbreviations where appropriate (e.g., BID for twice daily, TID for three times daily).\n- Include any warnings or side effects mentioned by the doctor in the Additional Instructions section.\n- If the doctor mentions any alternatives, include them in the Additional Instructions section.\n- List all tests performed, even if results are pending.\n- Include follow-up instructions if mentioned by the doctor.\n- For each medication, provide clear and specific instructions in the Sig field.\n- If the doctor specifies a duration for a medication, include it in the Sig field.\n- Use a numbered list for multiple medications.\n\nRemember, always prioritize patient safety and clarity in the prescription. If there\'s any ambiguity or potential safety concern in the doctor\'s input, highlight it with [SAFETY CHECK REQUIRED] in the relevant section.\n\n## Examples:\n\nExample 1: Simple prescription for hypertension\n\nInput: "For a patient with hypertension, prescribe Lisinopril 10mg tablets, one tablet daily. They should take it in the morning. Dispense a 30-day supply with 2 refills. I want to see them back in 3 months for a blood pressure check."\n\nOutput:\n1. Patient Information:\n   - Name: [Leave blank for doctor to fill in]\n   - Date of Birth: [Leave blank for doctor to fill in]\n   - Date: [Current date]\n\n2. Diagnosis: Hypertension\n\n3. Medications:\n   1. a. Medication Name: Lisinopril\n      b. Strength: 10 mg\n      c. Form: Tablet\n      d. Sig: Take 1 tablet by mouth every morning\n      e. Dispense Amount: 30 tablets\n      f. Refills: 2\n\n4. Tests Performed: [NEEDS CLARIFICATION]\n\n5. Additional Instructions: None\n\n6. Follow-up: Return in 3 months for blood pressure check\n\n7. Prescribing Doctor: [Leave blank for doctor to fill in]\n\nExample 2: Complex prescription for diabetes and depression\n\nInput: "Patient diagnosed with type 2 diabetes and major depressive disorder. Recent HbA1c was 8.2%. Prescribe Metformin 500mg twice daily with meals, increase to 1000mg twice daily after 1 week if tolerated. Also, start Sertraline 50mg daily for depression, taken in the morning. Provide glucose test strips, patient to test blood sugar twice daily. Follow up in 2 weeks to assess medication tolerability."\n\nOutput:\n1. Patient Information:\n   - Name: [Leave blank for doctor to fill in]\n   - Date of Birth: [Leave blank for doctor to fill in]\n   - Date: [Current date]\n\n2. Diagnosis: Type 2 Diabetes Mellitus, Major Depressive Disorder\n\n3. Medications:\n   1. a. Medication Name: Metformin\n      b. Strength: 500 mg\n      c. Form: Tablet\n      d. Sig: Take 1 tablet by mouth twice daily with meals for 1 week, then increase to 2 tablets twice daily with meals if tolerated\n      e. Dispense Amount: 56 tablets\n      f. Refills: 0\n\n   2. a. Medication Name: Sertraline\n      b. Strength: 50 mg\n      c. Form: Tablet\n      d. Sig: Take 1 tablet by mouth every morning\n      e. Dispense Amount: 30 tablets\n      f. Refills: 0\n\n   3. a. Medication Name: Glucose Test Strips\n      b. Strength: N/A\n      c. Form: Test Strips\n      d. Sig: Test blood sugar twice daily\n      e. Dispense Amount: 60 strips\n      f. Refills: 0\n\n4. Tests Performed: HbA1c (Result: 8.2%)\n\n5. Additional Instructions: Monitor for side effects of Metformin and Sertraline. Report any significant adverse effects.\n\n6. Follow-up: Return in 2 weeks to assess medication tolerability\n\n7. Prescribing Doctor: [Leave blank for doctor to fill in]\n\nExample 3: Pediatric prescription for acute otitis media\n\nInput: "6-year-old patient with acute otitis media in the right ear. Prescribe amoxicillin suspension, 250mg/5mL, 15mg/kg/dose twice daily for 10 days. Patient weighs 20kg. Also recommend acetaminophen for pain as needed. Follow up if symptoms don\'t improve in 3 days."\n\nOutput:\n1. Patient Information:\n   - Name: [Leave blank for doctor to fill in]\n   - Date of Birth: [Leave blank for doctor to fill in]\n   - Date: [Current date]\n\n2. Diagnosis: Acute Otitis Media, Right Ear\n\n3. Medications:\n   1. a. Medication Name: Amoxicillin\n      b. Strength: 250 mg/5 mL\n      c. Form: Oral Suspension\n      d. Sig: Take 6 mL by mouth twice daily for 10 days\n      e. Dispense Amount: 120 mL\n      f. Refills: 0\n\n   2. a. Medication Name: Acetaminophen\n      b. Strength: [NEEDS CLARIFICATION] (Strength depends on the available formulation)\n      c. Form: [NEEDS CLARIFICATION] (Form depends on patient/parent preference)\n      d. Sig: Take as needed for pain. Do not exceed recommended dosage for age/weight.\n      e. Dispense Amount: [NEEDS CLARIFICATION]\n      f. Refills: 0\n\n4. Tests Performed: [NEEDS CLARIFICATION]\n\n5. Additional Instructions:\n   - Complete full course of antibiotics even if symptoms improve.\n   - For acetaminophen, follow package instructions for proper dosing based on child\'s weight.\n\n6. Follow-up: Return if symptoms don\'t improve in 3 days\n\n7. Prescribing Doctor: [Leave blank for doctor to fill in]\'\'\''),
  );

  final chat = model.startChat(history: [
    Content.multi([
      TextPart('Input: "Patient underwent laparoscopic cholecystectomy yesterday. Discharge with oxycodone 5mg tablets, 1-2 tablets every 4-6 hours as needed for severe pain, maximum 6 tablets per day. Also, ibuprofen 600mg every 6 hours for moderate pain. Prescribe ondansetron 4mg as needed for nausea. Follow up in 2 weeks for post-op check."\n'),
    ]),
    Content.model([
      TextPart('1. Patient Information:\n   - Name: [Leave blank for doctor to fill in]\n   - Date of Birth: [Leave blank for doctor to fill in]\n   - Date: [Current date]\n\n2. Diagnosis: Post-laparoscopic Cholecystectomy\n\n3. Medications:\n   1. a. Medication Name: Oxycodone\n      b. Strength: 5 mg\n      c. Form: Tablet\n      d. Sig: Take 1-2 tablets by mouth every 4-6 hours as needed for severe pain, maximum 6 tablets per day\n      e. Dispense Amount: 30 tablets \n      f. Refills: 0\n\n   2. a. Medication Name: Ibuprofen\n      b. Strength: 600 mg\n      c. Form: Tablet\n      d. Sig: Take 1 tablet by mouth every 6 hours as needed for moderate pain\n      e. Dispense Amount: 30 tablets\n      f. Refills: 0\n\n   3. a. Medication Name: Ondansetron\n      b. Strength: 4 mg\n      c. Form: Tablet \n      d. Sig: Take 1 tablet by mouth as needed for nausea\n      e. Dispense Amount: 10 tablets\n      f. Refills: 0\n\n4. Tests Performed: [NEEDS CLARIFICATION]\n\n5. Additional Instructions: \n   - [SAFETY CHECK REQUIRED] Patient should be advised to use caution when driving or operating heavy machinery due to potential sedation from oxycodone.\n   - [SAFETY CHECK REQUIRED] Educate patient on risks associated with taking ibuprofen and recommend alternate pain relievers if contraindicated (e.g., gastrointestinal issues).\n\n6. Follow-up: Return in 2 weeks for post-op check\n\n7. Prescribing Doctor: [Leave blank for doctor to fill in] \n'),
    ]),
  ]);
  final message = 'INSERT_INPUT_HERE';
  final content = Content.text(message);

  final response = await chat.sendMessage(content);
  print(response.text);
}